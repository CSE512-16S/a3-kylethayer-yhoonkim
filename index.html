<html>
<head>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/color-translator.css" rel="stylesheet">

<script src="js/jquery-1.12.0.min.js"></script>
<script src="js/d3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="SOM.js"></script>
<script src="color-utils.js"></script>
<script src="js/db.js"></script>
<script src="color-name-lookup.js"></script>

<script>

var currentLanguages = ["english", "spanish"]; //indexes are 0 for left, 1 for right
var currentLanguage = "english";
var currentOtherLanguage = "spanish";
var currentColors = ["", ""];
var currentColor = "";
var currentSide = 0;

var currentMouseOver = {};
currentMouseOver[currentLanguages[currentSide]] = "";
currentMouseOver[currentOtherLanguage] = "";


currentMouseOver[currentOtherLanguage] = "";

var N=40, M=20;
var d3Data =[];
var svg, somNodes;

var somWidth = 800;
var boxWidth = somWidth / N;
var boxHeight = boxWidth;
var somHeight = M * boxWidth;


function start(){
	$('#nav-translator').addClass('active');
	
	draw(num_answers_by_lang, languageDropdowns);

	loadAllColors(function(){
		draw(sorted_color_names_by_lang_name(currentLanguages[currentSide]), function(data){
			drawColorDropdowns(data, 0)
			loadSOM();
		});
		draw(sorted_color_names_by_lang_name(currentOtherLanguage), function(data){drawColorDropdowns(data, 1)});
		//drawColorDropdowns();

	});
}

function loadSOM(){
	loadColor(function(){
		createSOM();
		listColorNames();
	});
}

function languageDropdowns(languages){
	singleLanguageDropdown(languages, 0);
	singleLanguageDropdown(languages, 1);
}

function singleLanguageDropdown(languages, side){ //side is 0 for left, 1 for right
	languages.sort(function(a,b){
		return b.num_answers - a.num_answers;
	});
	
	var str = "<select class='form-control' onchange='selectLang(this);' style='width:50%' col="+(side+1)+">";
	languages.forEach(function(lang) {
		str += "<option value = '"+lang["language"] +"' ";
		if(lang["language"] == currentLanguages[side]){
			str += " selected = true ";
		}
		str += ">" + lang["language"] + "</option>";
	});
	str += "<select>"
	var div = document.getElementById("lang"+(side+1)+"Dropdown");
	div.innerHTML = str;
}

function drawColorDropdowns(colors, side){//side is 0 for left, 1 for right
	var str = "<select class='form-control' onchange='selectColorDropdown(this);' style='width:50%' col='1'>";
	if(currentColors[side] == ""){
		//TODO: correctly populate currentColor
		currentColors[side] = colors[0]["color_name"];
		currentColor = colors[0]["color_name"];
	}
	colors.forEach(function(color) {
		str += "<option value = '"+color["color_name"]+"' ";
		if(color["color_name"] == currentColor){
			str += " selected = true ";
		}
		str += ">" + color["color_name"] + "</option>";
	});
	str += "<select>"
	var div = document.getElementById("lang"+(side+1)+"ColorSelector");
	div.innerHTML = str;
}

function createSOM(){
	var testsom = new som(N, M, 3);
	var data = [];
	for(var i in currentColorIds){
		var color_id = currentColorIds[i];
		data.push([colorValues[color_id].r, colorValues[color_id].g, colorValues[color_id].b]);
	}
	data.sort(function() {
	  return .5 - Math.random();
	});
	testsom.train(data, 2000);
	
	//TODO: create distance function that incorporates naming
	//TODO: initialize SOM to all values
	if(!svg){
		drawSOMByD3(N, M, "SOM");
	}
	updateSOM(testsom, "SOM");

}

function updateSOM(testsom, divID){



	var d3Data = testsom.neurons.reduce(function(prev, neuron, i){
		return prev.concat(neuron.map(function(n,j){
			var color = n.weights.map(function(w){ return Math.round(w); });
			var result = {"color": color};
			result["colorInfo"] = JSON.parse(JSON.stringify(reverseLookup({r: color[0], g: color[1], b: color[2]})[0]));
			result["x"] = i;
			result["y"] = j;
			return result;
		}))
	},[]);

	somNodes = svg.selectAll(".som-node")
 			.data(d3Data);
 	
 	somNodes.enter()
 				.append("g")
 				.attr("class","som-node");

	somNodes.append("rect")
	 				.attr("x", function(d){ return d.x * boxWidth ; })
	 				.attr("y", function(d){ return d.y * boxHeight ; })
	 				// .attr("rx",1)
	 				// .attr("ry",1)
	 				.attr("width", boxWidth)
	 				.attr("height", boxHeight)
	 				.style("fill", function(d){ return "rgb(" + d.color[0] + "," + d.color[1] + "," + d.color[2] +")"});
	
	somNodes.append("text")
	 				.attr("x", function(d){ return (d.x+0.5) * boxWidth; })
	 				.attr("y", function(d){ return (d.y+0.75) * boxHeight; })
	 				.attr("text-anchor", "middle")
	 				.attr("class",".som-node-text")
	 				.append("text").text("");

	somNodes.append("line")
	 				.attr("x1", function(d){ return d.x * boxWidth ; })
	 				.attr("y1", function(d){ return (d.y) * boxHeight - 1 ; })
	 				.attr("x2", function(d){ return (d.x + 1) * boxWidth; })
	 				.attr("y2", function(d){ return (d.y) * boxHeight -1; })
	 				.attr("class","outer top")
	 				.attr("stroke","white")
	 				.attr("stroke-width","2")
	 				.attr("stroke-opacity",0)
 	somNodes.append("line")
	 				.attr("x1", function(d){ return (d.x) * boxWidth - 1; })
	 				.attr("y1", function(d){ return (d.y) * boxHeight; })
	 				.attr("x2", function(d){ return (d.x) * boxWidth - 1; })
	 				.attr("y2", function(d){ return (d.y + 1) * boxHeight; })
	 				.attr("class","outer left")
	 				.attr("stroke","white")
	 				.attr("stroke-width","2")
	 				.attr("stroke-opacity",0)

	somNodes.append("line")
	 				.attr("x1", function(d){ return d.x * boxWidth ; })
	 				.attr("y1", function(d){ return (d.y) * boxHeight + 1 ; })
	 				.attr("x2", function(d){ return (d.x + 1) * boxWidth; })
	 				.attr("y2", function(d){ return (d.y) * boxHeight + 1; })
	 				.attr("class","inner top")
	 				.attr("stroke","red")
	 				.attr("stroke-width","2")
	 				.attr("stroke-opacity",0)

 	somNodes.append("line")
	 				.attr("x1", function(d){ return (d.x) * boxWidth + 1; })
	 				.attr("y1", function(d){ return (d.y) * boxHeight; })
	 				.attr("x2", function(d){ return (d.x) * boxWidth + 1; })
	 				.attr("y2", function(d){ return (d.y + 1) * boxHeight; })
	 				.attr("class","inner left")
	 				.attr("stroke","red")
	 				.attr("stroke-width","2")
	 				.attr("stroke-opacity",0)



}



function drawSOMByD3(n, m, divID){
  svg = d3.select("#"+divID).append("svg")
      .attr("width", somWidth )
      .attr("height", somHeight )
      .style("background-color","black")
}


function colorNameSpan(name, lang){
	str = "<span onmouseenter='nameMouseOver(this);' onmouseleave='nameMouseLeave(this);' " +
				"onclick='nameMouseClick(this);' " + 
				"class = 'nameSpan' " +
				"name='"+name+"' lang='"+lang+"'>" + 
					name + "," +  
				"</span> ";
	return str;
}

function listColorNames(){
	var lang1ColorName = listColorNamesForLang(0);
	var lang2ColorName = listColorNamesForLang(1);
	highlightColor(lang1ColorName, lang2ColorName);
}

function listColorNamesForLang(side){
    var lang = currentLanguages[side]
	var langStr = "current";
	if(lang != currentLanguages[currentSide]){
		langStr = "other";
	}
	
	var similarDiv = document.getElementById("Lang"+(side+1)+"Colors").getElementsByClassName("similarColorNames")[0];
	var ret = getColorNames(lang, currentColor, currentLanguages[currentSide]);
	var matchingColorNamesArray = ret[0];
	var unMatchingColorNamesArray = ret[1];

	var str = "";
	for(var i in matchingColorNamesArray){
		var spanStr =  colorNameSpan(
						matchingColorNamesArray[i].name,  
						langStr);
						//currentColors[]
		if(matchingColorNamesArray[i].name == currentColors[side]){
			//skip current color
		} else{
			str += spanStr;
		}
		
	}
	
	for(var i in unMatchingColorNamesArray){
		var spanStr =  colorNameSpan(
						unMatchingColorNamesArray[i].name,  
						langStr);
		if(unMatchingColorNamesArray[i].name == currentColors[side]){
			//skip current color
		} else{
			str += spanStr;
		}
		
	}
	similarDiv.innerHTML = str;
	

	if(matchingColorNamesArray.length > 0){
		return matchingColorNamesArray[0].name;
	} else if(unMatchingColorNamesArray.length > 0){
		return unMatchingColorNamesArray[0].name;
	}
}

function highlightColor(lang1ColorName, lang2ColorName){
	var divName = "SOM";
	
	// $("#" + divName + " .som-node rect").each(function(i){
	// 	var JQthis = $(this);
	// 	var lang1Names = this.__data__.colorInfo.names[currentLanguages[0]];
	// 	var lang2Names = this.__data__.colorInfo.names[currentOtherLanguage];
	// 	var x = Number(JQthis.attr("x")), 
	// 			y = Number(JQthis.attr("y"));
	// 	if(lang1Names && lang1Names.hasOwnProperty(lang1ColorName)){
	// 		if(lang2Names && lang2Names.hasOwnProperty(lang2ColorName)){
	// 			JQthis.attr("transform", "");
	// 		}
	// 		else{
	// 			JQthis.attr("transform", "rotate(45," + (x + 5) + "," + (y + 9) + ")");
	// 		}
	// 	}
	// 	else if (lang2Names && lang2Names.hasOwnProperty(lang2ColorName)) {	
	// 		JQthis.attr("transform", "rotate(-45," + (x + 5) + "," + (y + 9) + ")");
	// 	}
	// 	else{
	// 		JQthis.css("fill","black")	
	// 	}
	// });

	// $("#" + divName + " .som-node text").each(function(i){
	// 	var JQthis = $(this);
	// 	var lang1Names = this.__data__.colorInfo.names[currentLanguage];
	// 	var lang2Names = this.__data__.colorInfo.names[currentOtherLanguage];
		
	// 	if(lang1Names && lang1Names.hasOwnProperty(lang1ColorName)){
	// 		if(lang2Names && lang2Names.hasOwnProperty(lang2ColorName)){
	// 			this.innerHTML = "<>";
	// 		}
	// 		else if(lang === currentLanguages[0]){
	// 			this.innerHTML = "<&nbsp;";
	// 		}
	// 	}
	// 	else if (lang2Names && lang2Names.hasOwnProperty(lang2ColorName)) {	
	// 		this.innerHTML = "&nbsp;>";
	// 	}
	// 	else{
	// 	}
	// });

	var JQSomNode = $("#" + divName + " .som-node");
	for (var i = 0; i < N; i++) {
		for (var j = 0; j < M; j++) {
			var thisNode = JQSomNode[ i * M + j ];
			var JQNode = $(thisNode);
			
			thisNode["hasLang1ColorName"] = hasColorName(thisNode, lang1ColorName, currentLanguage);
			thisNode["hasLang2ColorName"] = hasColorName(thisNode, lang2ColorName, currentOtherLanguage);
			

			//upper one
			if (j!==0) {
				var upper = JQSomNode[i * M + j - 1];
				// upper["hasLang1ColorName"] = hasColorName(upper, lang1ColorName, currentLanguage);
				// upper["hasLang2ColorName"] = hasColorName(upper, lang2ColorName, currentOtherLanguage);

				//xor
				if (upper.hasLang1ColorName != thisNode.hasLang1ColorName ) {
					$('> .outer.top', thisNode).attr("stroke-opacity",1);
				}
				if (upper.hasLang2ColorName != thisNode.hasLang2ColorName ) {
					$('> .inner.top', thisNode).attr("stroke-opacity",1);
				};
			}
			//left one
			if (i!==0) {
				var left = JQSomNode[(i-1) * M + j ];
				// left["hasLang1ColorName"] = hasColorName(left, lang1ColorName, currentLanguage);
				// left["hasLang2ColorName"] = hasColorName(left, lang2ColorName, currentOtherLanguage);

				//xor
				if (left.hasLang1ColorName != thisNode.hasLang1ColorName ) {
					$('> .outer.left', thisNode).attr("stroke-opacity",1);
				}
				if (left.hasLang2ColorName != thisNode.hasLang2ColorName ) {
					$('> .inner.left', thisNode).attr("stroke-opacity",1);
				};
			}
						
		};
	};

	function hasColorName(node, langColorName, which){
		var langNames = node.__data__.colorInfo.names[which];

		return !!langNames && langNames.hasOwnProperty(langColorName)
	}
	
		

		


	
}




function nameMouseOver(element){
	var lang = currentLanguage;
	if(element.attributes.lang.nodeValue == "other"){
		lang = currentOtherLanguage;
	}
	currentMouseOver[lang] = element.attributes.name.nodeValue;
	
	$(".som-node").each(function(i){
		var langNames = this.__data__.colorInfo.names[lang];
		if( langNames && langNames.hasOwnProperty(currentMouseOver[lang])){
			this.style.opacity = 1;
		}
		else {
			this.style.opacity = .25;
		}
	});
}

function nameMouseLeave(element){
	var lang = currentLanguage;
	if(element.attributes.lang.nodeValue == "other"){
		lang = currentOtherLanguage;
	}
	
	if(currentMouseOver[lang] == element.attributes.name.nodeValue){
	
		$(".som-node").each(function(i){
			this.style.opacity = 1;
		});
	}
}


function nameMouseClick(element){
    var side = 0;
	var divName = "SOM1";
	var lang = currentLanguage;
	if(element.attributes.lang.nodeValue == "other"){
		side = 1;
		divName = "SOM2";
		lang = currentOtherLanguage;
	}
	
	var lang1 = currentLanguage;
	var lang2 = currentOtherLanguage;
	if (lang == currentOtherLanguage) {
		lang1 = currentOtherLanguage;
		lang2 = currentLanguage;
	}
	
	var colorName = element.attributes.name.nodeValue;
	
	//selectColor(lang1, lang2, colorName)
	selectColor2(colorName, side);
}


function selectLang(element){
	if(element.attributes.col.nodeValue == 1){
		currentLanguage = element.value;
		currentColor = ""; //if the left column is changed, we need to clear the current color name
	} else {
		currentOtherLanguage = element.value;
	}

	loadAllColors(function(){
		draw(sorted_color_names_by_lang_name(currentLanguages[currentSide]), function(data){
			drawColorDropdowns(data, 0)
			loadSOM();
		});
		draw(sorted_color_names_by_lang_name(currentOtherLanguage), function(data){drawColorDropdowns(data, 1);});
	});
}

function selectColorDropdown(element){
    var side = 0;
	var lang1 = currentLanguage;
	var lang2 = currentOtherLanguage; 
	if(element.attributes.col.nodeValue == 2){
		lang1 = currentOtherLanguage;
		lang2 = currentLanguage;
		side = 1;
	}
	var colorName =  element.value
	
	//selectColor(lang1, lang2, colorName)
	selectColor2(colorName, side);
}

function selectColor2(colorName, side){
	currentColors[side] = colorName;
	currentSide = side;
	
	//currentMouseOver[currentLanguage] = "";
	//currentMouseOver[currentOtherLanguage] = "";
	loadSOM();
	
}

function selectColor(lang1, lang2, colorName){
	currentLanguage = lang1;
	currentOtherLanguage = lang2;
	
	currentColor = colorName;
	
	currentMouseOver[currentLanguage] = "";
	currentMouseOver[currentOtherLanguage] = "";

	draw(num_answers_by_lang, languageDropdowns);
	draw(sorted_color_names_by_lang_name(currentLanguage), function(data){drawColorDropdowns(data, 0);});
	draw(sorted_color_names_by_lang_name(currentOtherLanguage), function(data){drawColorDropdowns(data, 1);});
	loadSOM();
}

</script>
</head>

<body onload = "start()">
    <div class="container">
  	  <!--#include virtual="../navbar.html" -->
	 <H1 style="text-align: center;">Color Translator</H1>
	  	<div class="row align-center">
  			<div id="SOM" class="SOM col-xs-offset-1 col-xs-9 text-center"></div>
      </div>
      <div class="row align-center">
        <div id="language1" class="lang-region col-xs-6">
          <div id="SOM1" class="SOM"></div>
		  <br>
		  <div style="float:left;margin-right:15px">Language: </div><div id="lang1Dropdown"></div>
		  <br>
          <div style="float:left;margin-right:45px">Color: </div><div id="lang1ColorSelector"></div>
		  <div style="margin-left:130px; margin-top:3px;">Lock Color: <input type="checkbox" id="lock1" /></div>
          <div id="Lang1Colors">
            <div class="name-list">
              <b>Related Colors</b>
              <div class="similarColorNames"></div>
            </div>
          </div>
        </div>

        <div id="language2" class="lang-region col-xs-6">
          <div id="SOM2" class="SOM"></div>
		  <br>
		  <div style="float:left;margin-right:15px">Language: </div><div id="lang2Dropdown"></div>
		  <br>
          <div style="float:left;margin-right:45px">Color: </div><div id="lang2ColorSelector"></div>
		  <div style="margin-left:130px; margin-top:3px;">Lock Color: <input type="checkbox" id="lock2" /></div>
          <div id="Lang2Colors">
            <div class="name-list">
              <b>Related Colors</b>
              <div class="similarColorNames"></div>
            </div>
          </div>
        </div>
      </div>

    </div>

</div>
</body>
</html>
