<html>
<head>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/color-translator.css" rel="stylesheet">

<script src="js/jquery-1.12.0.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="SOM.js"></script>
<script src="color-utils.js"></script>
<script src="js/db.js"></script>
<script src="color-name-lookup.js"></script>

<script>

var currentLanguage = "english";
var currentOtherLanguage = "spanish";
var currentColor = "";

var currentMouseOver = {};
currentMouseOver[currentLanguage] = "";
currentMouseOver[currentOtherLanguage] = "";

var currentSelected = {};
currentSelected[currentLanguage] = "";
currentMouseOver[currentOtherLanguage] = "";

function start(){
	$('#nav-translator').addClass('active');
	draw(num_answers_by_lang, languageDropdowns);

	loadAllColors(function(){
		draw(sorted_color_names_by_lang_name(currentLanguage), function(data){
			colorDropdowns1(data);
			loadSOM();
		});
		draw(sorted_color_names_by_lang_name(currentOtherLanguage), colorDropdowns2);
		//drawColorDropdowns();

	});
}

function loadSOM(){
	loadColor(function(){
		createSOM();
		listColorNames();
	});
}

function languageDropdowns(languages){
	languages.sort(function(a,b){
		return b.num_answers - a.num_answers;
	});
	var str = "<select class='form-control' onchange='selectLang(this);' col=1 '>";
	languages.forEach(function(lang) {
		str += "<option value = '"+lang["language"] +"' ";
		if(lang["language"] == currentLanguage){
			str += " selected = true ";
		}
		str += ">" + lang["language"] + "</option>";
	});
	str += "<select>"
	var div = document.getElementById("lang1Dropdown");
	div.innerHTML = str;
	
	var str = "<select class='form-control' onchange='selectLang(this);' col=2 >";
	languages.forEach(function(lang) {
		str += "<option value = '"+lang["language"]+ "' ";
		if(lang["language"] == currentOtherLanguage){
			str += " selected = true ";
		}
		str += ">" + lang["language"] + "</option>";
	});
	str += "<select>"
	var div = document.getElementById("lang2Dropdown");
	div.innerHTML = str;
}

function colorDropdowns1(colors){
	var str = "<select class='form-control' onchange='selectColorDropdown(this);' col=1>";
	if(currentColor == ""){
		//TODO: correctly populate currentColor
		currentColor = colors[0]["color_name"];
	}
	colors.forEach(function(color) {
		str += "<option value = '"+color["color_name"]+"' ";
		if(color["color_name"] == currentColor){
			str += " selected = true ";
		}
		str += ">" + color["color_name"] + "</option>";
	});
	str += "<select>"
	var div = document.getElementById("lang1ColorSelector");
	div.innerHTML = str;
}
	
//TODO: merge these two functions
function colorDropdowns2(colors){
	var str = "<select class='form-control' onchange='selectColorDropdown(this);' col=2 >" +
					"<option value = '' selcted = true></option>";
	colors.forEach(function(color) {
		str += "<option value = '"+color["color_name"] +"' ";
		str += ">" + color["color_name"] + "</option>";
	});
	str += "<select>"
	var div = document.getElementById("lang2ColorSelector");
	div.innerHTML = str;
}

function createSOM(){
	var testsom = new som(20, 20, 3);
	var data = [];
	for(var i in currentColorIds){
		var color_id = currentColorIds[i];
		data.push([colorValues[color_id].r, colorValues[color_id].g, colorValues[color_id].b]);
	}
	data.sort(function() {
	  return .5 - Math.random();
	});
	testsom.train(data, 2000);
	
	//TODO: create distance function that incorporates naming
	//TODO: initialize SOM to all values
	drawSOM(testsom, "SOM1");
	drawSOM(testsom, "SOM2");

}

function drawSOM(testsom, divName){
	var div = document.getElementById(divName);
	var str = "";
	
	viewedColorNames = {};
	
	for(var i = 0; i < testsom.neurons.length; i++){
		for(var j = 0; j < testsom.neurons[0].length; j++){
			var color = testsom.neurons[i][j].weights;
			for(var k = 0; k < color.length; k++){
				color[k] = Math.round(color[k]);
			}
			
			var temp = reverseLookup({r: color[0], g: color[1], b: color[2]});
			var colorInfo = temp[0];
			var rgb_string = temp[1];
			
			//for now check if it is the selected color
			var currentColorCount = 0
			if(typeof colorInfo !== "undefined" && typeof colorInfo.names[currentLanguage] !== "undefined" 
				&& typeof colorInfo.names[currentLanguage][currentColor] !== "undefined"){
				currentColorCount = colorInfo.names[currentLanguage][currentColor];
			}			
			
			str += "<DIV class='" + divName+ "-node som-node'"+
				"style='background-color:rgb("+
				color[0]+","+color[1]+","+color[2]+
				");' " +
				"colorInfo='" + rgb_string + "' ";
			// add info on names in languages
			if(typeof colorInfo !== "undefined"){
				if(typeof colorInfo.names[currentLanguage] !== "undefined" ){
					str += "lang" + currentLanguage + "='" +
							Object.keys(colorInfo.names[currentLanguage]).join(",") +
							"' ";
					addViewedColorNames(colorInfo.id, currentLanguage, colorInfo.names[currentLanguage])
				}
				if(typeof colorInfo.names[currentOtherLanguage] !== "undefined" ){
					str += "lang" + currentOtherLanguage + "='" +
							Object.keys(colorInfo.names[currentOtherLanguage]).join(",") +
							"' ";
					addViewedColorNames(colorInfo.id, currentLanguage, colorInfo.names[currentLanguage])
				}
			} else {
				str += "color='color not loaded' ";
			}
			
			str += 	"'>"
			str += "</DIV>";
		}
		str += "<DIV style='clear:both;'></DIV>";
	}

	div.innerHTML = str;
	div.style.width = "400px";
}

function colorNameSpan(name, lang){
	str = "<span onmouseenter='nameMouseOver(this);' onmouseleave='nameMouseLeave(this);' " +
				"onclick='nameMouseClick(this);' ondblclick='nameMouseDblClick(this);' " + 
				"class = 'nameSpan'" +
				"name='"+name+"' lang='"+lang+"'>" + 
					name +  
				"</span><br>";
	return str;
}

function listColorNames(){
	listColorNamesForLang(currentLanguage);
	listColorNamesForLang(currentOtherLanguage);

}

function listColorNamesForLang(lang){
	var langStr = "current";
	var divName = "Lang1Colors";
	if(lang != currentLanguage){
		langStr = "other";
		divName = "Lang2Colors"
	}
	
	var matchingDiv = document.getElementById(divName).getElementsByClassName("matchingColorNames")[0];
	var similarDiv = document.getElementById(divName).getElementsByClassName("similarColorNames")[0];
	var ret = getColorNames(lang, currentColor, currentLanguage);
	var matchingColorNamesArray = ret[0];
	var unMatchingColorNamesArray = ret[1];

	var str = "";
	for(var i in matchingColorNamesArray){
		var spanStr =  colorNameSpan(
						matchingColorNamesArray[i].name,  
						langStr);
		if(matchingColorNamesArray[i].name == currentSelected[lang]){
			str = spanStr + str;
		} else{
			str += spanStr;
		}
		
	}
	matchingDiv.innerHTML = str;

	var str = "";
	for(var i in unMatchingColorNamesArray){
		var spanStr =  colorNameSpan(
						unMatchingColorNamesArray[i].name,  
						langStr);
		if(unMatchingColorNamesArray[i].name == currentSelected[lang]){
			str = spanStr + str;
		} else{
			str += spanStr;
		}
		
	}
	similarDiv.innerHTML = str;
	
	if(matchingColorNamesArray.length > 0){
		highlightColor(lang, matchingColorNamesArray[0].name);
	} else if(unMatchingColorNamesArray.length > 0){
		highlightColor(lang, unMatchingColorNamesArray[0].name);
	}
}

function highlightColor(lang, colorName){
	var langStr = "current";
	var divName = "SOM1";
	if(lang != currentLanguage){
		langStr = "other";
		divName = "SOM2"
	}
	$(".nameSpan").each(function(i){
		if(this.attributes["lang"].nodeValue == langStr){
			if(this.attributes.name.nodeValue == colorName){
				this.classList.add("mark");
				this.classList.add("lead");
			} else {
				this.classList.remove("mark");
				this.classList.remove("lead");
			}
		}

	});
	
	$("."+divName+"-node").each(function(i){
		if(typeof this.attributes["lang" + lang] != "undefined"){
			var names = this.attributes["lang" + lang].nodeValue.split(",");
			if(names.includes(colorName)){
				this.innerHTML = "*";
			} else {
				this.innerHTML = "";
			}
		} else{
			this.innerHTML = "";
		}
	});
	
}




function nameMouseOver(element){
	var divName = "SOM1";
	var lang = currentLanguage;
	if(element.attributes.lang.nodeValue == "other"){
		divName = "SOM2";
		lang = currentOtherLanguage;
	}
	
	currentMouseOver[lang] = element.attributes.name.nodeValue;
	
	$(".som-node").each(function(i){
		if(typeof this.attributes["lang" + lang] != "undefined"){
			var names = this.attributes["lang" + lang].nodeValue.split(",");
			if(names.includes(element.attributes.name.nodeValue)){
				this.style.opacity = 1;
			} else {
				this.style.opacity = .75;
			}
		} else{
			this.style.opacity = .75;
		}
	});
}

function nameMouseLeave(element){
	var divName = "SOM1";
	var lang = currentLanguage;
	if(element.attributes.lang.nodeValue == "other"){
		divName = "SOM2";
		lang = currentOtherLanguage;
	}
	
	if(currentMouseOver[lang] == element.attributes.name.nodeValue){
	
		$(".som-node").each(function(i){
			this.style.opacity = 1;
		});
	}
}

function nameMouseClick(element){
	var divName = "SOM1";
	var lang = currentLanguage;
	if(element.attributes.lang.nodeValue == "other"){
		divName = "SOM2";
		lang = currentOtherLanguage;
	}
	
	highlightColor(lang, element.attributes.name.nodeValue);
}


function nameMouseDblClick(element){
	var divName = "SOM1";
	var lang = currentLanguage;
	if(element.attributes.lang.nodeValue == "other"){
		divName = "SOM2";
		lang = currentOtherLanguage;
	}
	
	var lang1 = currentLanguage;
	var lang2 = currentOtherLanguage;
	if (lang == currentOtherLanguage) {
		lang1 = currentOtherLanguage;
		lang2 = currentLanguage;
	}
	
	var colorName = element.attributes.name.nodeValue;
	
	selectColor(lang1, lang2, colorName)
}


function selectLang(element){
	if(element.attributes.col.nodeValue == 1){
		currentLanguage = element.value;
		currentColor = ""; //if the left column is changed, we need to clear the current color name
	} else {
		currentOtherLanguage = element.value;
	}
	
	currentSelected[currentLanguage] = "";
	currentSelected[currentOtherLanguage] = "";

	loadAllColors(function(){
		draw(sorted_color_names_by_lang_name(currentLanguage), function(data){
			colorDropdowns1(data);
			loadSOM();
		});
		draw(sorted_color_names_by_lang_name(currentOtherLanguage), colorDropdowns2);
	});
}

function selectColorDropdown(element){
	var lang1 = currentLanguage;
	var lang2 = currentOtherLanguage; 
	if(element.attributes.col.nodeValue == 2){
		lang1 = currentOtherLanguage;
		lang2 = currentLanguage;
	}
	var colorName =  element.value
	
	selectColor(lang1, lang2, colorName)
}

function selectColor(lang1, lang2, colorName){
	currentLanguage = lang1;
	currentOtherLanguage = lang2;
	
	currentColor = colorName;
	
	currentMouseOver[currentLanguage] = "";
	currentMouseOver[currentOtherLanguage] = "";

	currentSelected[currentLanguage] = currentColor;
	currentSelected[currentOtherLanguage] = "";

	draw(num_answers_by_lang, languageDropdowns);
	draw(sorted_color_names_by_lang_name(currentLanguage), colorDropdowns1);
	draw(sorted_color_names_by_lang_name(currentOtherLanguage), colorDropdowns2);
	loadSOM();
}

</script>
</head>

<body onload = "start()">
    <div class="container">
  	  <!--#include virtual="../navbar.html" -->

      <div class="row align-center">
        <div id="language1" class="lang-region col-xs-6">
          <div id="lang1Dropdown"></div>
          <div id="lang1ColorSelector"></div>
          <div id="SOM1" class="SOM"></div>
          <div id="Lang1Colors">
            <div class="name-list">
              <b>Matching Colors</b>
              <div class="matchingColorNames"></div>
            </div>
            <div class="name-list">
              <b>Similar Colors</b>
              <div class="similarColorNames"></div>
            </div>
          </div>
        </div>

        <div id="language2" class="lang-region col-xs-6">
          <div id="lang2Dropdown"></div>
          <div id="lang2ColorSelector"></div>
          <div id="SOM2" class="SOM"></div>
          <div id="Lang2Colors">
            <div class="name-list">
              <b>Matching Colors</b>
              <div class="matchingColorNames"></div>
            </div>
            <div class="name-list">
              <b>Similar Colors</b>
              <div class="similarColorNames"></div>
            </div>
          </div>
        </div>
      </div>

    </div>

</div>
</body>
</html>
